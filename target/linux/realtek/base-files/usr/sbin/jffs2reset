#!/bin/sh

OVERLAY_LABEL="etc"
CONFIRM=n
REBOOT=n

confirm()
{
  [ "$1" = "y" ] && return 0
  echo "This will erase all settings and remove any installed packages. Are you sure? [N/y]"
  read CONFIRM
  [ "$CONFIRM" = "y" -o "$CONFIRM" = "Y" ] && return 0
  return 1
}

do_reset_nofs()
{
  local OVERLAY_DEV=
  for item in `cat /proc/cmdline`; do
    case $item in
      overlay=*)		OVERLAY_DEV=${item:8};;
    esac
  done
  if [ -z "$OVERLAY_DEV" ]; then
    OVERLAY_DEV=`blkid -L $OVERLAY_LABEL | grep /mmcblk0p`
  fi
  if [ -z "$OVERLAY_DEV" ]; then
    echo "overlay not found by cmdline or label, maybe we are already in resetting?" >&2
    return 0
  fi

  echo "RESET000" | dd of=$OVERLAY_DEV bs=512 count=1 conv=notrunc
  echo 3 > /proc/sys/vm/drop_caches
  return 0
}

do_reset()
{
  if [ -f /.recovery_mode ]; then
    mount_root || ( echo "/overlay mount failed!" ; exit 1 )
    rm -rf /overlay/upper
    mkdir /overlay/upper
    sync /overlay
  else
    if touch /overlay/.reset; then
      sync /overlay
    else
      do_reset_nofs
    fi
  fi
  [ "$REBOOT" = "y" ] && reboot
  exit 0
}

while [[ $# -gt 0 ]]; do
  key="$1"
  case $key in
    -y) CONFIRM=y ;;
    -r) REBOOT=y ;;
  esac
  shift
done

confirm $CONFIRM && do_reset
exit 0
